package out

import (
	"context"
	"time"

	"github.com/google/uuid"
)

// CalendarRepository defines the outbound port for calendar persistence.
type CalendarRepository interface {
	// CRUD operations
	Create(ctx context.Context, event *CalendarEventEntity) error
	Update(ctx context.Context, event *CalendarEventEntity) error
	Delete(ctx context.Context, userID uuid.UUID, id int64) error
	GetByID(ctx context.Context, userID uuid.UUID, id int64) (*CalendarEventEntity, error)

	// Query operations
	List(ctx context.Context, userID uuid.UUID, query *CalendarListQuery) ([]*CalendarEventEntity, int, error)
	GetUpcoming(ctx context.Context, userID uuid.UUID, limit int) ([]*CalendarEventEntity, error)

	// RSVP operations
	SaveResponse(ctx context.Context, response *AttendeeResponseEntity) error
	GetResponses(ctx context.Context, eventID int64) ([]*AttendeeResponseEntity, error)

	// Sync operations
	Upsert(ctx context.Context, event *CalendarEventEntity) error
}

// CalendarEventEntity represents calendar event domain entity.
type CalendarEventEntity struct {
	ID               int64
	UserID           uuid.UUID
	Provider         string
	ProviderID       string
	CalendarID       string
	Title            string
	Description      string
	Location         string
	StartTime        time.Time
	EndTime          time.Time
	Timezone         string
	IsAllDay         bool
	IsRecurring      bool
	RecurrenceRule   string
	RecurringEventID *int64
	Attendees        []AttendeeEntity
	OrganizerEmail   string
	Status           string
	Visibility       string
	MeetingURL       string
	MeetingProvider  string
	Reminders        []ReminderEntity
	AutoGenerated    bool
	RelatedEmailID   *int64
	Color            string
	Transparency     string
	Categories       []string
	Attachments      []CalendarAttachmentEntity
	CreatedAt        time.Time
	UpdatedAt        time.Time
	SyncedAt         *time.Time
}

// AttendeeEntity represents attendee domain entity.
type AttendeeEntity struct {
	Email    string
	Name     string
	Status   string
	Optional bool
}

// ReminderEntity represents reminder domain entity.
type ReminderEntity struct {
	Method  string
	Minutes int
}

// CalendarAttachmentEntity represents calendar attachment domain entity.
type CalendarAttachmentEntity struct {
	Title    string
	URL      string
	MimeType string
	Size     int64
}

// AttendeeResponseEntity represents attendee response domain entity.
type AttendeeResponseEntity struct {
	ID              int64
	EventID         int64
	UserID          uuid.UUID
	Email           string
	Name            string
	Response        string
	ResponseComment string
	RespondedAt     *time.Time
	CreatedAt       time.Time
	UpdatedAt       time.Time
}

// CalendarListQuery represents calendar list query parameters.
type CalendarListQuery struct {
	StartTime  *time.Time
	EndTime    *time.Time
	CalendarID string
	Provider   string
	Status     string
	Search     string
	Limit      int
	Offset     int
}

// CalendarListEntity represents a calendar (not event) in the calendars table.
type CalendarListEntity struct {
	ID           int64
	UserID       uuid.UUID
	ConnectionID int64
	Provider     string
	ProviderID   string
	Name         string
	Description  string
	Color        string
	IsDefault    bool
	IsReadOnly   bool
	CreatedAt    time.Time
	UpdatedAt    time.Time
}

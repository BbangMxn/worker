# Outbound Ports (Driven Ports)

> Core에서 외부 의존성을 호출하기 위한 인터페이스 정의.
> 실제 구현체는 `adapter/out/`에 위치.

## 파일별 역할

| 파일 | 인터페이스 | 구현체 위치 |
|------|-----------|-------------|
| `mail_repository.go` | MailRepository | `adapter/out/persistence/` |
| `mail_body_repository.go` | MailBodyRepository | `adapter/out/mongodb/` |
| `mail_provider.go` | MailProvider | `adapter/out/provider/gmail,outlook/` |
| `messaging.go` | MessageProducer | `adapter/out/messaging/` |
| `vector_store.go` | VectorStore | `core/agent/rag/vectorstore.go` |
| `calendar_repository.go` | CalendarRepository | `adapter/out/persistence/` |
| `contact_repository.go` | ContactRepository | `adapter/out/persistence/` |
| `profile_repository.go` | PersonalizationStore | `adapter/out/persistence/` |
| `oauth.go` | OAuthConnectionRepository | `adapter/out/persistence/` |
| `llm.go` | LLMClient | `core/agent/llm/` |
| `cache.go` | Cache | `adapter/out/cache/` |

## 핵심 인터페이스

### MailRepository
PostgreSQL에 이메일 메타데이터 저장.

```go
type MailRepository interface {
    // CRUD
    Create(ctx, mail *MailEntity) error
    Update(ctx, mail *MailEntity) error
    GetByID(ctx, id int64) (*MailEntity, error)
    
    // 읽음 상태 관리
    UpdateReadStatus(ctx, id int64, isRead bool) error
    BatchUpdateReadStatus(ctx, ids []int64, isRead bool) error
    
    // AI 결과 업데이트
    UpdateAIResult(ctx, id int64, result *MailAIResult) error
    
    // 통계
    CountUnread(ctx, userID uuid.UUID, connectionID *int64) (int, error)
}
```

### MailBodyRepository
MongoDB에 이메일 본문(HTML/Text) 저장.

```go
type MailBodyRepository interface {
    SaveBody(ctx, body *MailBodyEntity) error
    GetBody(ctx, emailID int64) (*MailBodyEntity, error)
    BulkDeleteBody(ctx, emailIDs []int64) error
}
```

### MessageProducer
Redis Stream에 비동기 작업 발행.

```go
type MessageProducer interface {
    // 메일
    PublishMailSend(ctx, *MailSendJob) error
    PublishMailSync(ctx, *MailSyncJob) error
    
    // AI
    PublishAIClassify(ctx, *AIClassifyJob) error
    PublishAISummarize(ctx, *AISummarizeJob) error
    
    // RAG
    PublishRAGIndex(ctx, *RAGIndexJob) error
    PublishRAGBatchIndex(ctx, *RAGBatchIndexJob) error
    
    // 프로필
    PublishProfileAnalyze(ctx, *ProfileAnalyzeJob) error
}
```

### VectorStore
RAG용 벡터 저장소 (pgvector).

```go
type VectorStore interface {
    Store(ctx, id string, embedding []float32, metadata map[string]interface{}) error
    Search(ctx, queryEmbedding []float32, topK int) ([]*VectorSearchResult, error)
    SearchWithFilter(ctx, embedding []float32, topK int, opts *VectorSearchOptions) ([]*VectorSearchResult, error)
    Delete(ctx, id string) error
}
```

## 핵심 엔티티

### MailEntity (메일 메타데이터)
```go
type MailEntity struct {
    ID            int64
    ExternalID    string      // Provider ID (Gmail/Outlook)
    UserID        uuid.UUID
    ConnectionID  int64
    
    // 상태
    IsRead        bool        // 읽음 여부
    IsDraft       bool
    HasAttachment bool
    
    // AI 결과
    AIStatus      string      // pending, completed, failed
    Category      string      // primary, social, promotions...
    Priority      int         // 1(긴급) ~ 5(낮음)
    Summary       string      // AI 요약
    Intent        string      // action_required, fyi, urgent...
    IsUrgent      bool        // 긴급 플래그
    DueDate       *string     // 감지된 마감일
    
    // 워크플로우
    WorkflowStatus string     // todo, done, snoozed
    SnoozedUntil   *time.Time
}
```

### MailAIResult (AI 처리 결과)
```go
type MailAIResult struct {
    Status     string   // pending, processing, completed, failed
    Category   string   // primary, social, promotions, updates, newsletters
    Priority   int      // 1(highest) ~ 5(lowest)
    Sentiment  float64  // -1.0 ~ 1.0
    Summary    string   // 사용자 언어로 요약
    ActionItem string   // 필요한 액션
    Tags       []string // AI 생성 태그
    Intent     string   // action_required, fyi, urgent, follow_up, scheduling
    IsUrgent   bool     // Priority=1 또는 Intent=urgent
    DueDate    *string  // YYYY-MM-DD 형식
}
```

## Job 타입 (messaging.go)

### AI Jobs
```go
// 분류
type AIClassifyJob struct {
    UserID  string
    EmailID int64
}

// 요약 (자동/수동)
type AISummarizeJob struct {
    UserID        string
    EmailID       int64
    Level         string  // brief, detailed
    Language      string  // ko, en, ja 등 (비어있으면 자동 감지)
    AutoGenerated bool    // true면 이미 요약 있을 시 스킵
}
```

### RAG Jobs
```go
// 개별 인덱싱
type RAGIndexJob struct {
    UserID  string
    EmailID int64
}

// 배치 인덱싱 (초기 동기화)
type RAGBatchIndexJob struct {
    UserID       string
    ConnectionID int64
    EmailIDs     []int64
}
```

## 설계 원칙

1. **인터페이스 분리**: 각 저장소별로 독립 인터페이스
2. **도메인 중심**: Entity는 core에서 정의, adapter에서 변환
3. **비동기 우선**: 무거운 작업은 MessageProducer로 발행
